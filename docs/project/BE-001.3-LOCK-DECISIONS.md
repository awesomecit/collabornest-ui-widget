# BE-001.3 Lock Decisions Summary

**Meeting**: Nov 18, 2025 | **Status**: âœ… APPROVED | **Delivery**: Week 3 (Nov 25)

---

## ðŸŽ¯ Core Principle

**YAGNI**: Ship simplest working solution Week 3, defer complexity to backlog.

**Clean Code**: 2-week backward compatibility grace period, then kill deprecated code.

---

## âœ… Approved Decisions (Week 3)

| # | Decision | Choice | Rationale |
|---|----------|--------|-----------|
| 1 | Viewer Permission | No WebSocket check | Upstream ACL (Keycloak) |
| 2 | Lock Upgrade | Deny | Simplest, rare conflicts |
| 3 | Disconnect | 30s grace period | WiFi glitches vs fairness |
| 4 | Tabs Per User | Single tab only | Simplest enforcement |
| 5 | Admin Override | No override | YAGNI (not requested) |
| 6 | Lock TTL | 5 minutes (300s) | Phone call safe, not lunch block |
| 7 | Viewer Limits | No limit | WebSocket handles 100+ |
| 8 | Heartbeat | 60 seconds | 5 pings before expiry |
| 9 | Backward Compat | Warn + Kill (2 weeks) | Clean code, grace period |

---

## ðŸ“‹ Week 3 Implementation

### Backend Checklist
- [ ] RedisLockService TDD (2 days)
- [ ] WebSocket lock events (1 day)
- [ ] BDD test suite - 6 scenarios (1 day)
- [ ] API documentation (0.5 day)

### Redis Schema
```
lock:{type}:{id}:{section} â†’ userId
Example: lock:document:123:main â†’ user_abc123
TTL: 300s (5 min)
```

### WebSocket Events
```javascript
// Client â†’ Server
socket.emit('acquire_lock', { resourceId: 'document:123:main' });
socket.emit('release_lock', { resourceId: 'document:123:main' });
socket.emit('heartbeat', { resourceId: 'document:123:main' });

// Server â†’ Client
socket.emit('lock_acquired', { resourceId, userId, timestamp });
socket.emit('lock_released', { resourceId, reason });
socket.emit('lock_denied', { resourceId, holder: { id, name } });
```

### Environment Config
```env
LOCK_TTL=300                # 5 minutes
LOCK_HEARTBEAT_INTERVAL=60  # 60 seconds  
LOCK_GRACE_PERIOD=30        # 30 seconds
```

---

## ðŸ”„ Migration Timeline

**Week 3** (Nov 18-22): Support old format `"doc:123"` â†’ auto-convert to `"doc:123:main"` + deprecation log  
**Week 4** (Nov 25-29): Frontend migrates all calls to explicit format  
**Week 5** (Dec 2): Remove auto-convert, only explicit format supported

---

## ðŸ“¦ Future Backlog (Trigger-Based)

| Feature | Decision | Trigger | Priority |
|---------|----------|---------|----------|
| Lock Queue | 2-B | User complaints | P2 |
| Multi-Tab | 4-B | Dual-monitor workflow | P3 |
| Admin Override | 5-A | Emergency scenario | P2 |
| Viewer Limits | 7-B | Performance >50 viewers | P3 |

**Review**: Week 4 retrospective (Nov 25), Week 8 review (Dec 16)

---

## ðŸ“Š Success Metrics

### Functional (Week 3)
- [ ] Single editor enforced
- [ ] Lock TTL 5 min working
- [ ] Heartbeat 60s working
- [ ] Disconnect 30s grace working
- [ ] Toast "Locked by [User]" working
- [ ] Backward compat + warnings working

### Performance
- Lock acquire: <50ms
- Heartbeat: <10KB/min per user
- Disconnect detection: 30s Â±5s

### Coverage
- 6 BDD scenarios: 100%
- Unit tests: >90%

---

**Next Review**: Monday, Nov 25, 2025 (Demo + Metrics)
