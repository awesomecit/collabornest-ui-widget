<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CollaborNest - Complete Reports Testing</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #2563eb;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-700: #374151;
      --gray-900: #111827;
      --editor-color: #8b5cf6;
      --viewer-color: #3b82f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
    }

    .app-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    /* HEADER */
    .app-header {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .app-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .connection-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .connection-status.connected {
      background: #d1fae5;
      color: #065f46;
    }

    .connection-status.disconnected {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* USER PANEL */
    .user-panel {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      padding: 16px;
      background: var(--gray-100);
      border-radius: 8px;
    }

    .user-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .user-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .user-field input {
      padding: 8px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
    }

    .user-field input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .user-actions {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: var(--gray-700);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--gray-900);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* MAIN LAYOUT */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }

    /* REPORTS LIST */
    .reports-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .reports-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .report-card {
      background: var(--gray-50);
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .report-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .report-card.active {
      border-color: var(--primary-color);
      background: #eff6ff;
    }

    .report-card.has-viewers {
      border-color: var(--viewer-color);
      background: #dbeafe;
    }

    .report-card.has-editors {
      border-color: var(--success-color);
      background: #d1fae5;
    }

    .report-card.has-conflict {
      border-color: var(--warning-color);
      background: #fef3c7;
    }

    .report-id {
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-700);
      background: white;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .report-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .report-meta {
      font-size: 13px;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .report-users {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--gray-300);
    }

    .user-badge-mini {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 500;
    }

    .user-badge-mini.editor {
      background: #ede9fe;
      color: #6b21a8;
    }

    .user-badge-mini.viewer {
      background: #dbeafe;
      color: #1e40af;
    }

    /* REPORT DETAIL */
    .report-detail {
      display: none;
      margin-top: 20px;
    }

    .report-detail.active {
      display: block;
    }

    .detail-header {
      background: var(--gray-50);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .detail-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .detail-meta {
      font-size: 14px;
      color: var(--gray-700);
    }

    .back-button {
      background: white;
      border: 1px solid var(--gray-300);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .back-button:hover {
      background: var(--gray-100);
    }

    /* TABS */
    .tabs-container {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      overflow: hidden;
    }

    .tabs-header {
      display: flex;
      border-bottom: 2px solid var(--gray-200);
      background: var(--gray-50);
    }

    .tab-button {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      position: relative;
      transition: all 0.2s;
    }

    .tab-button:hover {
      background: white;
    }

    .tab-button.active {
      color: var(--primary-color);
      background: white;
    }

    .tab-button.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary-color);
    }

    .tab-users-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      margin-left: 6px;
      border-radius: 9px;
      font-size: 10px;
      font-weight: 600;
      background: var(--gray-300);
      color: var(--gray-700);
      cursor: help;
      transition: all 0.2s;
    }

    .tab-users-count:hover {
      background: var(--gray-700);
      color: white;
      transform: scale(1.1);
    }

    .tab-button.active .tab-users-count {
      background: var(--primary-color);
      color: white;
    }

    .tab-button.active .tab-users-count:hover {
      background: #1d4ed8;
      transform: scale(1.1);
    }

    .tab-content {
      display: none;
      padding: 20px;
    }

    .tab-content.active {
      display: block;
    }

    .tab-placeholder {
      background: var(--gray-50);
      border: 2px dashed var(--gray-300);
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      color: var(--gray-700);
    }

    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .mode-button {
      flex: 1;
      padding: 10px;
      border: 2px solid var(--gray-300);
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .mode-button:hover {
      border-color: var(--primary-color);
    }

    .mode-button.active {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }

    .active-users-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--gray-900);
    }

    .active-users-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .active-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid var(--gray-200);
    }

    .active-user.editor {
      border-color: var(--editor-color);
      background: #faf5ff;
    }

    .active-user.viewer {
      border-color: var(--viewer-color);
      background: #eff6ff;
    }

    .active-user.me {
      border-width: 2px;
      font-weight: 600;
    }

    .active-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gray-300);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .active-user.editor .active-user-avatar {
      background: var(--editor-color);
    }

    .active-user.viewer .active-user-avatar {
      background: var(--viewer-color);
    }

    .active-user-info {
      flex: 1;
    }

    .active-user-name {
      font-size: 13px;
      font-weight: 500;
    }

    .active-user-mode {
      font-size: 11px;
      color: var(--gray-700);
    }

    /* SIDEBAR */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .sidebar-panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* EVENT LOG */
    .event-log {
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: #1F2937;
      color: #F3F4F6;
      padding: 16px;
      border-radius: 6px;
    }

    .event-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.05);
    }

    .event-timestamp {
      color: #9CA3AF;
      margin-right: 8px;
    }

    .event-type {
      font-weight: 700;
      margin-right: 8px;
    }

    .event-type.CONNECT { color: #10B981; }
    .event-type.CONNECT_ERROR { color: #EF4444; }
    .event-type.DISCONNECT { color: #F59E0B; }
    .event-type.RESOURCE_JOINED { color: #3B82F6; }
    .event-type.RESOURCE_LEFT { color: #8B5CF6; }
    .event-type.USER_JOINED { color: #06B6D4; }
    .event-type.USER_LEFT { color: #F97316; }

    .event-data {
      color: #D1D5DB;
      white-space: pre-wrap;
      margin-top: 4px;
      padding-left: 16px;
      font-size: 11px;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--gray-700);
      font-size: 13px;
    }

    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      
      .user-panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- HEADER -->
    <div class="app-header">
      <div class="header-top">
        <div>
          <div class="app-title">CollaborNest - Complete Reports Testing</div>
          <div style="font-size: 14px; color: var(--gray-700); margin-top: 4px;">
            Test multi-user collaboration with medical reports and tabs
          </div>
        </div>
        <div class="connection-info">
          <div class="connection-status disconnected" id="connectionStatus">
            <span class="status-indicator"></span>
            <span>Disconnected</span>
          </div>
        </div>
      </div>

      <!-- USER PANEL -->
      <div class="user-panel">
        <div class="user-field">
          <label>User ID</label>
          <input type="text" id="userId" placeholder="user_abc123">
        </div>
        <div class="user-field">
          <label>Username</label>
          <input type="text" id="username" placeholder="dr_rossi">
        </div>
        <div class="user-field">
          <label>Email</label>
          <input type="text" id="email" placeholder="rossi@example.com">
        </div>
        <div class="user-actions">
          <button class="btn btn-secondary" id="generateUserBtn">Generate User</button>
          <button class="btn btn-primary" id="connectBtn">Connect</button>
          <button class="btn btn-danger" id="disconnectBtn" style="display: none;">Disconnect</button>
        </div>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div class="main-layout">
      <!-- LEFT: REPORTS -->
      <div class="reports-section">
        <div class="section-title">üìö Medical Reports</div>
        <div class="reports-list" id="reportsList"></div>

        <!-- REPORT DETAIL -->
        <div class="report-detail" id="reportDetail">
          <button class="back-button" onclick="app.showReportsList()">‚Üê Back to Reports</button>
          <div class="detail-header">
            <div class="detail-title" id="detailTitle"></div>
            <div class="detail-meta" id="detailMeta"></div>
          </div>

          <div class="tabs-container">
            <div class="tabs-header" id="tabsHeader"></div>
            <div id="tabsContent"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: SIDEBAR -->
      <div class="sidebar">
        <!-- ACTIVE USERS -->
        <div class="sidebar-panel">
          <div class="sidebar-title">üë• Active Users in Current Tab</div>
          <div class="active-users-list" id="activeUsersList">
            <div class="empty-state">Select a report and tab to see users</div>
          </div>
        </div>

        <!-- EVENT LOG -->
        <div class="sidebar-panel">
          <div class="sidebar-title">üìã Event Log</div>
          <div class="event-log" id="eventLog"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // MOCK DATA
    const MOCK_REPORTS = [
      {
        id: 'MR-2024-001',
        patientName: 'Mario Bianchi',
        procedure: 'Appendicectomia',
        date: '16/11/2024',
        tabs: [
          { id: 'surgical-notes', name: 'Note Chirurgiche', icon: 'üìù' },
          { id: 'patient-data', name: 'Dati Paziente', icon: 'üìã' },
          { id: 'procedure-steps', name: 'Steps Procedura', icon: 'üìÑ' }
        ]
      },
      {
        id: 'MR-2024-002',
        patientName: 'Laura Verdi',
        procedure: 'Colecistectomia',
        date: '15/11/2024',
        tabs: [
          { id: 'surgical-notes', name: 'Note Chirurgiche', icon: 'üìù' },
          { id: 'patient-data', name: 'Dati Paziente', icon: 'üìã' },
          { id: 'procedure-steps', name: 'Steps Procedura', icon: 'üìÑ' }
        ]
      },
      {
        id: 'MR-2024-003',
        patientName: 'Giuseppe Neri',
        procedure: 'Ernia Inguinale',
        date: '15/11/2024',
        tabs: [
          { id: 'surgical-notes', name: 'Note Chirurgiche', icon: 'üìù' },
          { id: 'patient-data', name: 'Dati Paziente', icon: 'üìã' },
          { id: 'procedure-steps', name: 'Steps Procedura', icon: 'üìÑ' }
        ]
      },
      {
        id: 'MR-2024-004',
        patientName: 'Anna Russo',
        procedure: 'Tiroidectomia',
        date: '14/11/2024',
        tabs: [
          { id: 'surgical-notes', name: 'Note Chirurgiche', icon: 'üìù' },
          { id: 'patient-data', name: 'Dati Paziente', icon: 'üìã' },
          { id: 'procedure-steps', name: 'Steps Procedura', icon: 'üìÑ' }
        ]
      },
      {
        id: 'MR-2024-005',
        patientName: 'Marco Ferrari',
        procedure: 'Gastrectomia',
        date: '14/11/2024',
        tabs: [
          { id: 'surgical-notes', name: 'Note Chirurgiche', icon: 'üìù' },
          { id: 'patient-data', name: 'Dati Paziente', icon: 'üìã' },
          { id: 'procedure-steps', name: 'Steps Procedura', icon: 'üìÑ' }
        ]
      }
    ];

    // JWT GENERATOR - Uses mock server (no crypto.subtle needed!)
    async function generateJWT(userId, username, email) {
      console.log('[JWT] üîë Generating JWT for:', username);
      
      // Try JWT mock server first (port 3001)
      try {
        const response = await fetch('http://localhost:3001/auth/generate-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, username, email })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('[JWT] ‚úÖ Token from JWT mock server');
          return data.token;
        }
      } catch (e) {
        console.log('[JWT] ‚ö†Ô∏è JWT mock server not available (port 3001)');
      }

      // Fallback: Simple client-side JWT (ONLY FOR TESTING!)
      // In production, ALWAYS generate JWT server-side
      console.log('[JWT] ‚ö†Ô∏è Using client-side fallback (NOT SECURE!)');
      
      const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      
      const now = Math.floor(Date.now() / 1000);
      const payload = btoa(JSON.stringify({
        sub: userId,
        username: username,
        email: email,
        iss: 'collabornest',
        aud: 'collabornest-users',
        iat: now,
        exp: now + 3600
      })).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

      // Simple signature (NOT SECURE - only for testing!)
      const fakeSignature = btoa(`${userId}-${username}-${now}`)
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

      const token = `${header}.${payload}.${fakeSignature}`;
      console.log('[JWT] ‚ö†Ô∏è Token generated (client-side fallback)');
      return token;
    }

    // WEBSOCKET SERVICE
    class WebSocketService {
      constructor() {
        this.socket = null;
        this.connected = false;
        this.currentUser = null;
        this.currentResourceId = null;
        this.currentMode = 'viewer';
        this.activeUsers = [];
        this.onConnectionChange = null;
        this.onUsersChange = null;
        this.onEvent = null;
        this.onCrossTabUserJoined = null; // Cross-tab presence update
        this.onCrossTabUserLeft = null;   // Cross-tab presence update
        this.pendingJoin = null; // Store pending join request
      }

      async connect(userId, username, email) {
        console.log('[WS] üîå Starting connection...');
        this.addEvent('CONNECT', `Connecting as ${username}...`);
        
        try {
          const jwt = await generateJWT(userId, username, email);
          console.log('[WS] üîë JWT generated:', jwt.substring(0, 50) + '...');
          this.currentUser = { userId, username, email };

          this.socket = io('http://localhost:3000/collaboration', {
            path: '/ws/socket.io',
            transports: ['websocket', 'polling'],
            auth: { token: jwt },
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
          });

          this.setupListeners();
        } catch (error) {
          console.error('[WS] ‚ùå Connection failed:', error);
          this.addEvent('CONNECT_ERROR', `Failed: ${error.message}`);
          throw error;
        }
      }

      setupListeners() {
        this.socket.on('connect', () => {
          console.log('[WS] ‚úÖ Connected! Socket ID:', this.socket.id);
          this.connected = true;
          this.addEvent('CONNECT', `‚úÖ Connected! Socket ID: ${this.socket.id}`);
          
          if (this.onConnectionChange) {
            this.onConnectionChange(true);
          }

          // Execute pending join if any
          if (this.pendingJoin) {
            console.log('[WS] üîÑ Executing pending join:', this.pendingJoin);
            this.joinResource(this.pendingJoin.resourceId, this.pendingJoin.mode);
            this.pendingJoin = null;
          }
        });

        this.socket.on('connect_error', (error) => {
          console.error('[WS] ‚ùå Connection error:', error.message);
          this.connected = false;
          this.addEvent('CONNECT_ERROR', `‚ùå Connection failed: ${error.message}`);
          if (this.onConnectionChange) {
            this.onConnectionChange(false);
          }
        });

        this.socket.on('disconnect', (reason) => {
          console.log('[WS] üîå Disconnected:', reason);
          this.connected = false;
          this.addEvent('DISCONNECT', `üîå Disconnected: ${reason}`);
          if (this.onConnectionChange) {
            this.onConnectionChange(false);
          }
        });

        this.socket.on('resource:joined', (data) => {
          console.log('[WS] üì• resource:joined event received:', data);
          if (data.success) {
            this.addEvent('RESOURCE_JOINED', `‚úÖ Joined ${data.resourceId} as ${data.mode}`, data.users);
            this.activeUsers = data.users || [];
            console.log('[WS] üë• Active users updated:', this.activeUsers);
            if (this.onUsersChange) {
              this.onUsersChange(this.activeUsers);
            }
          } else {
            console.error('[WS] ‚ùå Join failed:', data.message);
            this.addEvent('RESOURCE_JOINED', `‚ùå Failed to join: ${data.message}`);
          }
        });

        this.socket.on('resource:left', (data) => {
          console.log('[WS] üì§ resource:left event received:', data);
          this.addEvent('RESOURCE_LEFT', `üëã Left ${data.resourceId}`);
        });

        this.socket.on('user:joined', (data) => {
          console.log('[WS] üë§ user:joined event received:', data);
          console.log('[WS] üîç Current resource:', this.currentResourceId);
          console.log('[WS] üîç Event resourceId:', data.resourceId);
          console.log('[WS] üîç Is same resource?', data.resourceId === this.currentResourceId);
          
          this.addEvent('USER_JOINED', `üë§ ${data.username} joined ${data.resourceId} as ${data.mode}`, data);
          
          // Update for current resource (active users panel)
          if (data.resourceId === this.currentResourceId) {
            const existingIndex = this.activeUsers.findIndex(u => u.userId === data.userId);
            if (existingIndex === -1) {
              this.activeUsers.push({
                userId: data.userId,
                username: data.username,
                email: data.email,
                socketId: data.socketId,
                mode: data.mode,
                joinedAt: data.joinedAt
              });
              console.log('[WS] ‚ûï User added to current resource. Total:', this.activeUsers.length);
              console.log('[WS] üìã Updated active users list:', this.activeUsers.map(u => u.username).join(', '));
              console.log('[WS] üîÑ Triggering UI update via onUsersChange callback');
              if (this.onUsersChange) {
                this.onUsersChange(this.activeUsers);
              }
            } else {
              console.log('[WS] ‚ÑπÔ∏è User already in list, skipping');
            }
          }
          
          // CROSS-TAB UPDATE: Notify app about user in OTHER tabs
          if (this.onCrossTabUserJoined) {
            console.log('[WS] üîÑ Triggering cross-tab update for resource:', data.resourceId);
            this.onCrossTabUserJoined(data);
          }
        });

        this.socket.on('user:left', (data) => {
          console.log('[WS] üëã user:left event received:', data);
          console.log('[WS] üîç Current resource:', this.currentResourceId);
          console.log('[WS] üîç Event resourceId:', data.resourceId);
          console.log('[WS] üîç Is same resource?', data.resourceId === this.currentResourceId);
          
          this.addEvent('USER_LEFT', `üëã ${data.username} left ${data.resourceId}`, data);
          
          // Update for current resource (active users panel)
          if (data.resourceId === this.currentResourceId) {
            const beforeCount = this.activeUsers.length;
            this.activeUsers = this.activeUsers.filter(u => u.userId !== data.userId);
            const afterCount = this.activeUsers.length;
            
            console.log('[WS] ‚ûñ User removed from current resource. Before:', beforeCount, 'After:', afterCount);
            console.log('[WS] üìã Remaining active users:', this.activeUsers.map(u => u.username).join(', ') || '(none)');
            console.log('[WS] üîÑ Triggering UI update via onUsersChange callback');
            
            if (this.onUsersChange) {
              this.onUsersChange(this.activeUsers);
            }
          }
          
          // CROSS-TAB UPDATE: Notify app about user leaving OTHER tabs
          if (this.onCrossTabUserLeft) {
            console.log('[WS] üîÑ Triggering cross-tab update for resource:', data.resourceId);
            this.onCrossTabUserLeft(data);
          }
        });
      }

      joinResource(resourceId, mode) {
        // Check if socket is connected
        if (!this.socket || !this.connected) {
          console.warn('[WS] ‚ö†Ô∏è Socket not connected yet, storing pending join');
          this.pendingJoin = { resourceId, mode };
          this.addEvent('WARNING', `‚ö†Ô∏è Waiting for connection before joining ${resourceId}...`);
          return;
        }

        console.log('[WS] üìç Joining resource:', resourceId, 'as', mode);

        // Leave current resource if different
        if (this.currentResourceId && this.currentResourceId !== resourceId) {
          console.log('[WS] üö™ Leaving current resource first:', this.currentResourceId);
          this.leaveResource();
        }

        this.currentResourceId = resourceId;
        this.currentMode = mode;
        this.addEvent('RESOURCE_JOIN', `üìç Joining ${resourceId} as ${mode}...`);
        
        console.log('[WS] üì§ Emitting resource:join:', { resourceId, mode });
        this.socket.emit('resource:join', { resourceId, mode });
      }

      leaveResource() {
        if (this.currentResourceId && this.socket && this.connected) {
          console.log('[WS] üö™ Leaving resource:', this.currentResourceId);
          this.addEvent('RESOURCE_LEAVE', `üö™ Leaving ${this.currentResourceId}...`);
          
          console.log('[WS] üì§ Emitting resource:leave:', { resourceId: this.currentResourceId });
          this.socket.emit('resource:leave', { resourceId: this.currentResourceId });
          
          this.currentResourceId = null;
          this.activeUsers = [];
          if (this.onUsersChange) {
            this.onUsersChange([]);
          }
        }
      }

      changeMode(mode) {
        if (this.currentResourceId && this.currentMode !== mode) {
          console.log('[WS] üîÑ Changing mode from', this.currentMode, 'to', mode);
          this.currentMode = mode;
          this.addEvent('MODE_CHANGE', `üîÑ Changing mode to ${mode}...`);
          this.joinResource(this.currentResourceId, mode);
        }
      }

      disconnect() {
        if (this.socket) {
          console.log('[WS] üîå Disconnecting...');
          this.leaveResource();
          this.socket.disconnect();
          this.connected = false;
        }
      }

      addEvent(type, message, data = null) {
        if (this.onEvent) {
          this.onEvent(type, message, data);
        }
      }
    }

    // APPLICATION
    class ReportsApp {
      constructor() {
        this.wsService = new WebSocketService();
        this.currentReport = null;
        this.currentTab = null;
        this.userPresenceByResource = {};

        this.wsService.onConnectionChange = (connected) => {
          this.updateConnectionStatus(connected);
        };

        this.wsService.onUsersChange = (users) => {
          this.updateActiveUsers(users);
        };

        this.wsService.onEvent = (type, message, data) => {
          this.addEventLog(type, message, data);
        };

        // CROSS-TAB PRESENCE UPDATES
        this.wsService.onCrossTabUserJoined = (data) => {
          this.handleCrossTabUserJoined(data);
        };

        this.wsService.onCrossTabUserLeft = (data) => {
          this.handleCrossTabUserLeft(data);
        };

        this.setupUI();
      }

      setupUI() {
        document.getElementById('generateUserBtn').onclick = () => this.generateUser();
        document.getElementById('connectBtn').onclick = () => this.connect();
        document.getElementById('disconnectBtn').onclick = () => this.disconnect();
        
        this.generateUser();
        this.renderReportsList();
      }

      generateUser() {
        const userId = 'user_' + Math.random().toString(36).substr(2, 9);
        const username = 'user_' + Math.random().toString(36).substr(2, 5);
        const email = `${username}@example.com`;

        document.getElementById('userId').value = userId;
        document.getElementById('username').value = username;
        document.getElementById('email').value = email;
      }

      async connect() {
        const userId = document.getElementById('userId').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;

        if (!userId || !username || !email) {
          alert('Please fill all user fields');
          return;
        }

        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('disconnectBtn').style.display = 'inline-block';

        await this.wsService.connect(userId, username, email);
      }

      disconnect() {
        this.wsService.disconnect();
        document.getElementById('connectBtn').style.display = 'inline-block';
        document.getElementById('disconnectBtn').style.display = 'none';
      }

      updateConnectionStatus(connected) {
        const statusEl = document.getElementById('connectionStatus');
        if (connected) {
          statusEl.className = 'connection-status connected';
          statusEl.innerHTML = '<span class="status-indicator"></span><span>Connected</span>';
        } else {
          statusEl.className = 'connection-status disconnected';
          statusEl.innerHTML = '<span class="status-indicator"></span><span>Disconnected</span>';
        }
      }

      renderReportsList() {
        const listEl = document.getElementById('reportsList');
        listEl.innerHTML = MOCK_REPORTS.map(report => {
          const users = this.getUsersForReport(report.id);
          const hasEditors = users.some(u => u.mode === 'editor');
          const hasViewers = users.some(u => u.mode === 'viewer');
          const hasConflict = users.filter(u => u.mode === 'editor').length > 1;

          let cardClass = 'report-card';
          if (this.currentReport && this.currentReport.id === report.id) cardClass += ' active';
          else if (hasConflict) cardClass += ' has-conflict';
          else if (hasEditors) cardClass += ' has-editors';
          else if (hasViewers) cardClass += ' has-viewers';

          const usersHtml = users.length > 0 ? `
            <div class="report-users">
              ${users.map(u => `
                <span class="user-badge-mini ${u.mode}">
                  ${u.mode === 'editor' ? '‚úèÔ∏è' : 'üëÅÔ∏è'} ${u.username}
                </span>
              `).join('')}
            </div>
          ` : '';

          return `
            <div class="${cardClass}" onclick="app.showReportDetail('${report.id}')">
              <span class="report-id">${report.id}</span>
              <div class="report-title">${report.patientName}</div>
              <div class="report-meta">
                <div>üìã ${report.procedure}</div>
                <div>üìÖ ${report.date}</div>
              </div>
              ${usersHtml}
            </div>
          `;
        }).join('');
      }

      getUsersForReport(reportId) {
        const report = MOCK_REPORTS.find(r => r.id === reportId);
        if (!report) return [];

        const allUsers = new Map();
        report.tabs.forEach(tab => {
          const resourceId = `${reportId}/${tab.id}`;
          const users = this.userPresenceByResource[resourceId] || [];
          users.forEach(user => {
            if (!allUsers.has(user.userId)) {
              allUsers.set(user.userId, user);
            }
          });
        });

        return Array.from(allUsers.values());
      }

      showReportDetail(reportId) {
        this.currentReport = MOCK_REPORTS.find(r => r.id === reportId);
        if (!this.currentReport) return;

        document.getElementById('reportDetail').classList.add('active');
        document.getElementById('detailTitle').textContent = `${this.currentReport.patientName} - ${this.currentReport.procedure}`;
        document.getElementById('detailMeta').innerHTML = `
          <strong>${this.currentReport.id}</strong> | üìÖ ${this.currentReport.date}
        `;

        this.renderTabs();
        this.showTab(this.currentReport.tabs[0].id);
        this.renderReportsList();
      }

      renderTabs() {
        const headerEl = document.getElementById('tabsHeader');
        const contentEl = document.getElementById('tabsContent');

        headerEl.innerHTML = this.currentReport.tabs.map(tab => {
          const resourceId = `${this.currentReport.id}/${tab.id}`;
          const users = this.userPresenceByResource[resourceId] || [];
          return `
            <button class="tab-button" data-tab="${tab.id}" onclick="app.showTab('${tab.id}')">
              ${tab.icon} ${tab.name}
              ${users.length > 0 ? `<span class="tab-users-count">${users.length}</span>` : ''}
            </button>
          `;
        }).join('');

        contentEl.innerHTML = this.currentReport.tabs.map(tab => `
          <div class="tab-content" data-tab="${tab.id}">
            <div class="mode-selector">
              <button class="mode-button" data-mode="viewer" onclick="app.changeMode('viewer')">
                üëÅÔ∏è Viewer
              </button>
              <button class="mode-button" data-mode="editor" onclick="app.changeMode('editor')">
                ‚úèÔ∏è Editor
              </button>
            </div>
            <div class="tab-placeholder">
              <h3>${tab.icon} ${tab.name}</h3>
              <p>Content placeholder for ${tab.name}</p>
              <p style="margin-top: 16px; font-size: 13px;">
                In production, this would show the actual report section content.
              </p>
            </div>
          </div>
        `).join('');
      }

      showTab(tabId) {
        if (this.currentTab === tabId) return;

        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabId);
        });

        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('active', content.dataset.tab === tabId);
        });

        const resourceId = `${this.currentReport.id}/${tabId}`;
        const mode = this.wsService.currentMode || 'viewer';
        this.wsService.joinResource(resourceId, mode);
        this.currentTab = tabId;

        this.updateModeButtons();
      }

      changeMode(mode) {
        this.wsService.changeMode(mode);
        this.updateModeButtons();
      }

      updateModeButtons() {
        document.querySelectorAll('.mode-button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mode === this.wsService.currentMode);
        });
      }

      updateActiveUsers(users) {
        console.log('[APP] üîÑ updateActiveUsers called with', users.length, 'users');
        console.log('[APP] üë• Users:', users.map(u => `${u.username} (${u.mode})`).join(', '));
        
        if (!this.currentTab) {
          console.log('[APP] ‚ö†Ô∏è No current tab, skipping update');
          document.getElementById('activeUsersList').innerHTML = '<div class="empty-state">Select a report and tab</div>';
          return;
        }

        const resourceId = `${this.currentReport.id}/${this.currentTab}`;
        console.log('[APP] üíæ Storing users for resource:', resourceId);
        this.userPresenceByResource[resourceId] = users;

        const listEl = document.getElementById('activeUsersList');
        if (users.length === 0) {
          console.log('[APP] üö´ No users, showing empty state');
          listEl.innerHTML = '<div class="empty-state">No users in this tab yet</div>';
        } else {
          console.log('[APP] ‚úÖ Rendering', users.length, 'users in Active Users sidebar');
          listEl.innerHTML = users.map(user => {
            const isMe = user.userId === this.wsService.currentUser.userId;
            console.log('[APP]   - User:', user.username, 'isMe:', isMe, 'mode:', user.mode);
            return `
              <div class="active-user ${user.mode} ${isMe ? 'me' : ''}">
                <div class="active-user-avatar">${user.username.substring(0, 2).toUpperCase()}</div>
                <div class="active-user-info">
                  <div class="active-user-name">${user.username}${isMe ? ' (You)' : ''}</div>
                  <div class="active-user-mode">${user.mode === 'editor' ? '‚úèÔ∏è Editor' : 'üëÅÔ∏è Viewer'}</div>
                </div>
              </div>
            `;
          }).join('');
        }

        console.log('[APP] üîÑ Updating report cards with presence badges');
        this.renderReportsList();

        console.log('[APP] üè∑Ô∏è Updating tab badges for all tabs');
        document.querySelectorAll('.tab-button').forEach(btn => {
          const tabId = btn.dataset.tab;
          const tabResourceId = `${this.currentReport.id}/${tabId}`;
          const tabUsers = this.userPresenceByResource[tabResourceId] || [];
          const badge = btn.querySelector('.tab-users-count');
          
          // Count OTHER users (exclude yourself)
          const otherUsers = tabUsers.filter(u => u.userId !== this.wsService.currentUser.userId);
          const otherUsersCount = otherUsers.length;
          
          console.log('[APP]   - Tab:', tabId, '| Total:', tabUsers.length, '| Others:', otherUsersCount);
          
          // Show badge only if there are OTHER users (not just you)
          if (otherUsersCount > 0) {
            console.log('[APP]     ‚úÖ Showing badge with OTHER users count:', otherUsersCount);
            const tooltipText = otherUsers.map(u => `${u.username} (${u.mode})`).join(', ');
            if (!badge) {
              btn.innerHTML += `<span class="tab-users-count" title="${tooltipText}">${otherUsersCount}</span>`;
            } else {
              badge.textContent = otherUsersCount;
              badge.title = tooltipText;
            }
          } else {
            console.log('[APP]     ‚ÑπÔ∏è Only you in this tab, hiding badge');
            if (badge) {
              badge.remove();
            }
          }
        });
        console.log('[APP] ‚úÖ updateActiveUsers complete');
      }

      handleCrossTabUserJoined(data) {
        console.log('[APP] üîî Cross-tab user joined:', data.username, '‚Üí', data.resourceId);
        
        // Check if this resource belongs to current report
        if (!this.currentReport) {
          console.log('[APP] ‚ÑπÔ∏è No current report, ignoring cross-tab event');
          return;
        }

        const resourceReportId = data.resourceId.split('/')[0];
        if (resourceReportId !== this.currentReport.id) {
          console.log('[APP] ‚ÑπÔ∏è Event for different report, ignoring');
          return;
        }

        // Update userPresenceByResource for the target tab
        if (!this.userPresenceByResource[data.resourceId]) {
          this.userPresenceByResource[data.resourceId] = [];
        }

        const existingIndex = this.userPresenceByResource[data.resourceId].findIndex(u => u.userId === data.userId);
        if (existingIndex === -1) {
          this.userPresenceByResource[data.resourceId].push({
            userId: data.userId,
            username: data.username,
            email: data.email,
            socketId: data.socketId,
            mode: data.mode,
            joinedAt: data.joinedAt
          });
          console.log('[APP] ‚ûï Added user to resource:', data.resourceId);
        }

        // Re-render badges and report cards
        this.updateAllTabBadges();
        this.renderReportsList();
      }

      handleCrossTabUserLeft(data) {
        console.log('[APP] üîî Cross-tab user left:', data.username, '‚Üê', data.resourceId);
        
        // Check if this resource belongs to current report
        if (!this.currentReport) {
          console.log('[APP] ‚ÑπÔ∏è No current report, ignoring cross-tab event');
          return;
        }

        const resourceReportId = data.resourceId.split('/')[0];
        if (resourceReportId !== this.currentReport.id) {
          console.log('[APP] ‚ÑπÔ∏è Event for different report, ignoring');
          return;
        }

        // Remove user from userPresenceByResource
        if (this.userPresenceByResource[data.resourceId]) {
          this.userPresenceByResource[data.resourceId] = 
            this.userPresenceByResource[data.resourceId].filter(u => u.userId !== data.userId);
          console.log('[APP] ‚ûñ Removed user from resource:', data.resourceId);
        }

        // Re-render badges and report cards
        this.updateAllTabBadges();
        this.renderReportsList();
      }

      updateAllTabBadges() {
        if (!this.currentReport) return;
        
        console.log('[APP] üè∑Ô∏è Updating ALL tab badges (cross-tab event)');
        document.querySelectorAll('.tab-button').forEach(btn => {
          const tabId = btn.dataset.tab;
          const tabResourceId = `${this.currentReport.id}/${tabId}`;
          const tabUsers = this.userPresenceByResource[tabResourceId] || [];
          const badge = btn.querySelector('.tab-users-count');
          
          // Count OTHER users (exclude yourself)
          const otherUsers = tabUsers.filter(u => u.userId !== this.wsService.currentUser.userId);
          const otherUsersCount = otherUsers.length;
          
          console.log('[APP]   - Tab:', tabId, '| Total:', tabUsers.length, '| Others:', otherUsersCount);
          
          // Show badge only if there are OTHER users
          if (otherUsersCount > 0) {
            const tooltipText = otherUsers.map(u => `${u.username} (${u.mode})`).join(', ');
            if (!badge) {
              btn.innerHTML += `<span class="tab-users-count" title="${tooltipText}">${otherUsersCount}</span>`;
            } else {
              badge.textContent = otherUsersCount;
              badge.title = tooltipText;
            }
          } else {
            if (badge) {
              badge.remove();
            }
          }
        });
      }

      showReportsList() {
        this.wsService.leaveResource();
        this.currentReport = null;
        this.currentTab = null;

        document.getElementById('reportDetail').classList.remove('active');
        this.renderReportsList();
        
        document.getElementById('activeUsersList').innerHTML = '<div class="empty-state">Select a report and tab</div>';
      }

      addEventLog(type, message, data = null) {
        const logEl = document.getElementById('eventLog');
        const timestamp = new Date().toLocaleTimeString();
        
        const dataStr = data ? `\n${JSON.stringify(data, null, 2)}` : '';
        
        const entry = document.createElement('div');
        entry.className = 'event-entry';
        entry.innerHTML = `
          <span class="event-timestamp">[${timestamp}]</span>
          <span class="event-type ${type}">${type}</span>
          <span>${message}</span>
          ${data ? `<div class="event-data">${dataStr}</div>` : ''}
        `;
        
        logEl.insertBefore(entry, logEl.firstChild);
        
        while (logEl.children.length > 100) {
          logEl.removeChild(logEl.lastChild);
        }
      }
    }

    const app = new ReportsApp();

    window.addEventListener('beforeunload', () => {
      app.disconnect();
    });
  </script>
</body>
</html>
